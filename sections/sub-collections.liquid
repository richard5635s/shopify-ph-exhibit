{%- liquid
  # Get sub-collections from metafield
  assign sub_collections_metafield = collection.metafields.custom.sub_collections
  assign sub_collections_list = blank
  assign has_visible_collections = false
  
  if sub_collections_metafield != blank
    assign sub_collections_list = sub_collections_metafield.value
    
    if sub_collections_list != blank
      for collection_ref in sub_collections_list
        assign sub_collection = blank
        
        if collection_ref.handle != blank
          assign sub_collection = collection_ref
        elsif collection_ref != blank
          assign collection_handle = collection_ref
          assign sub_collection = collections[collection_handle]
        endif
        
        if sub_collection != blank and sub_collection.handle != blank
          assign has_visible_collections = true
          break
        endif
      endfor
    endif
  endif
-%}

{%- if sub_collections_metafield != blank and has_visible_collections -%}
<section
  id="section-{{ section.id }}"
  class="section-container"
  data-color-scheme="{{ section.settings.color_scheme }}"
  style="--top-spacing-adjust: {{ section.settings.space_above }}; --bottom-spacing-adjust: {{ section.settings.space_below }};"
>
  <div class="text-scheme-text bg-scheme-background pt-top-section-vertical-spacing pb-bottom-section-vertical-spacing">
    
    {%- if section.settings.title != blank -%}
      <div class="wrapper mb-4">
        <h2 class="font-heading text-heading-standard">{{ section.settings.title }}</h2>
      </div>
    {%- endif -%}

    <div class="wrapper">
      <div class="sub-collections-scroll" id="scroll-container-{{ section.id }}" style="overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch;">
        <div class="flex gap-4" style="min-width: max-content;">
          {%- for collection_ref in sub_collections_list -%}
            {%- liquid
              assign sub_collection = blank
              
              if collection_ref.handle != blank
                assign sub_collection = collection_ref
              elsif collection_ref != blank
                assign collection_handle = collection_ref
                assign sub_collection = collections[collection_handle]
              endif
            -%}
            {%- if sub_collection != blank and sub_collection.handle != blank -%}
              <div class="sub-collection-item flex-shrink-0" style="width: {{ section.settings.item_width }}px;">
                <a href="{{ sub_collection.url }}" class="block">
                  {%- if sub_collection.featured_image -%}
                    <div class="mb-2" style="aspect-ratio: {{ section.settings.aspect_ratio }}; overflow: hidden;">
                      {{ sub_collection.featured_image | image_url: width: 400 | image_tag: loading: 'lazy', class: 'w-full h-full object-cover' }}
                    </div>
                  {%- else -%}
                    <div class="mb-2 bg-scheme-placeholder-background" style="aspect-ratio: {{ section.settings.aspect_ratio }}; display: flex; align-items: center; justify-content: center;">
                      <span class="text-scheme-placeholder-foreground">No Image</span>
                    </div>
                  {%- endif -%}
                  {%- if section.settings.show_title -%}
                    <div class="text-center">
                      <h3 class="text-sm break-words">{{ sub_collection.title }}</h3>
                    </div>
                  {%- endif -%}
                </a>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
      <div class="custom-scrollbar-indicator" id="scroll-indicator-{{ section.id }}">
        <div class="scrollbar-track">
          <div class="scrollbar-thumb" id="scroll-thumb-{{ section.id }}"></div>
        </div>
      </div>
    </div>

  </div>
</section>

{%- style -%}
  #section-{{ section.id }} .sub-collections-scroll {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  #section-{{ section.id }} .sub-collections-scroll::-webkit-scrollbar {
    display: none;
  }
  
  #section-{{ section.id }} .custom-scrollbar-indicator {
    display: flex;
    justify-content: center;
    margin-top: 12px;
    padding: 0 20%;
  }
  
  #section-{{ section.id }} .scrollbar-track {
    width: 40%;
    height: 2px;
    background: rgba(0, 0, 0, 0.1);
    position: relative;
    border-radius: 1px;
  }
  
  #section-{{ section.id }} .scrollbar-thumb {
    height: 2px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 1px;
    position: absolute;
    left: 0;
    top: 0;
    transition: left 0.1s ease-out, width 0.1s ease-out;
    min-width: 15px;
  }
  
  #section-{{ section.id }} .scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.7);
  }
{%- endstyle -%}

<script>
  (function() {
    const scrollContainer = document.getElementById('scroll-container-{{ section.id }}');
    const scrollThumb = document.getElementById('scroll-thumb-{{ section.id }}');
    
    if (!scrollContainer || !scrollThumb) return;
    
    function updateScrollbar() {
      const scrollWidth = scrollContainer.scrollWidth;
      const clientWidth = scrollContainer.clientWidth;
      const scrollLeft = scrollContainer.scrollLeft;
      const maxScroll = scrollWidth - clientWidth;
      
      if (maxScroll <= 0) {
        scrollThumb.parentElement.style.display = 'none';
        return;
      }
      
      scrollThumb.parentElement.style.display = 'flex';
      
      const thumbWidth = (clientWidth / scrollWidth) * 100 * 0.4;
      const scrollPercent = (scrollLeft / maxScroll) * 100;
      
      scrollThumb.style.width = Math.max(thumbWidth, 10) + '%';
      scrollThumb.style.left = scrollPercent + '%';
    }
    
    scrollContainer.addEventListener('scroll', updateScrollbar);
    window.addEventListener('resize', updateScrollbar);
    updateScrollbar();
  })();
</script>

{%- endif -%}

{% schema %}
{
  "name": "Sub Collections",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Sub Collections"
    },
    {
      "type": "range",
      "id": "item_width",
      "min": 120,
      "max": 400,
      "step": 20,
      "unit": "px",
      "label": "Item width",
      "default": 200
    },
    {
      "type": "text",
      "id": "aspect_ratio",
      "label": "Aspect ratio",
      "default": "1",
      "info": "Height/Width ratio (e.g., 1 = square, 0.8 = 4:5)"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show collection title",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "scheme_1",
      "label": "Color scheme"
    },
    {
      "type": "range",
      "id": "space_above",
      "min": 0,
      "max": 2,
      "step": 0.5,
      "unit": "x",
      "label": "Space above",
      "default": 1
    },
    {
      "type": "range",
      "id": "space_below",
      "min": 0,
      "max": 2,
      "step": 0.5,
      "unit": "x",
      "label": "Space below",
      "default": 1
    }
  ],
  "presets": [
    {
      "name": "Sub Collections"
    }
  ]
}
{% endschema %}
