{%- if section.blocks.size > 0 -%}
<section
  id="section-{{ section.id }}"
  class="section-container"
  data-color-scheme="{{ section.settings.color_scheme }}"
  style="--top-spacing-adjust: {{ section.settings.space_above }}; --bottom-spacing-adjust: {{ section.settings.space_below }};"
>
  <div class="text-scheme-text bg-scheme-background pt-top-section-vertical-spacing pb-bottom-section-vertical-spacing">
    
    {%- if section.settings.title != blank -%}
      <div class="wrapper sub-collections-wrapper mb-4">
        <h2 class="font-heading text-heading-standard">{{ section.settings.title }}</h2>
      </div>
    {%- endif -%}

    <div class="wrapper sub-collections-wrapper">
      <div class="sub-collections-scroll" id="scroll-container-{{ section.id }}" style="overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch;">
        <div class="flex gap-4" style="min-width: max-content;">
          {%- for block in section.blocks -%}
            {%- if block.settings.collection != blank -%}
              {%- assign sub_collection = block.settings.collection -%}
              {%- assign block_image = block.settings.image -%}
              
              <div class="sub-collection-item flex-shrink-0" style="width: {{ section.settings.item_width }}px;" {{ block.shopify_attributes }}>
                <a href="{{ sub_collection.url }}" class="block">
                  {%- if block_image != blank -%}
                    <div class="mb-6" style="aspect-ratio: {{ section.settings.aspect_ratio }}; overflow: hidden;">
                      {{ block_image | image_url: width: 400 | image_tag: loading: 'lazy', class: 'w-full h-full object-cover' }}
                    </div>
                  {%- elsif sub_collection.featured_image -%}
                    <div class="mb-6" style="aspect-ratio: {{ section.settings.aspect_ratio }}; overflow: hidden;">
                      {{ sub_collection.featured_image | image_url: width: 400 | image_tag: loading: 'lazy', class: 'w-full h-full object-cover' }}
                    </div>
                  {%- else -%}
                    <div class="mb-6 bg-scheme-placeholder-background" style="aspect-ratio: {{ section.settings.aspect_ratio }}; display: flex; align-items: center; justify-content: center;">
                      <span class="text-scheme-placeholder-foreground">No Image</span>
                    </div>
                  {%- endif -%}
                  {%- if section.settings.show_title -%}
                    <div class="text-center">
                      {%- liquid
                        assign display_title = sub_collection.title
                        if sub_collection.title contains ':'
                          assign title_parts = sub_collection.title | split: ':'
                          assign display_title = title_parts[1] | strip
                        endif
                      -%}
                      <h3 class="text-base break-words" style="font-size: 1rem; line-height: 1.5;">{{ display_title | upcase }}</h3>
                    </div>
                  {%- endif -%}
                </a>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
      <div class="custom-scrollbar-indicator" id="scroll-indicator-{{ section.id }}">
        <div class="scrollbar-track">
          <div class="scrollbar-thumb" id="scroll-thumb-{{ section.id }}"></div>
        </div>
      </div>
    </div>

  </div>
</section>

{%- style -%}
  #section-{{ section.id }} .sub-collections-wrapper {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
  
  #section-{{ section.id }} .sub-collections-scroll {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  #section-{{ section.id }} .sub-collections-scroll::-webkit-scrollbar {
    display: none;
  }
  
  #section-{{ section.id }} .custom-scrollbar-indicator {
    display: flex;
    justify-content: center;
    margin-top: 30px;
    padding: 0 20%;
  }
  
  #section-{{ section.id }} .scrollbar-track {
    width: 50%;
    height: 4px;
    background: rgba(255, 255, 255, 1);
    border: 1px solid rgba(0, 0, 0, 0.9); 
    position: relative;
    border-radius: 0px;
    cursor: pointer;
  }
  
  #section-{{ section.id }} .scrollbar-thumb {
    height: 2px;
    background: #BFBFBF;
    border-radius: 0px;
    position: absolute;
    left: 0;
    top: 0;
    transition: left 0.1s ease-out, width 0.1s ease-out;
    min-width: 30px;
    cursor: grab;
  }
  
  #section-{{ section.id }} .scrollbar-thumb:active {
    cursor: grabbing;
    background: rgba(0, 0, 0, 0.7);
  }
  
  #section-{{ section.id }} .scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.7);
  }
  
  @media (max-width: 450px) {
    #section-{{ section.id }} .custom-scrollbar-indicator {
      padding: 0;
    }
    
    #section-{{ section.id }} .scrollbar-track {
      width: 100%;
    }
    
    #section-{{ section.id }} .sub-collection-item {
      width: 140px !important;
    }
  }
{%- endstyle -%}

<script>
  (function() {
    const scrollContainer = document.getElementById('scroll-container-{{ section.id }}');
    const scrollThumb = document.getElementById('scroll-thumb-{{ section.id }}');
    const scrollTrack = scrollThumb ? scrollThumb.parentElement : null;
    const scrollIndicator = document.getElementById('scroll-indicator-{{ section.id }}');
    
    if (!scrollContainer || !scrollThumb || !scrollTrack) return;
    
    let isDragging = false;
    let startX = 0;
    let startScrollLeft = 0;
    
    function updateScrollbar() {
      const scrollWidth = scrollContainer.scrollWidth;
      const clientWidth = scrollContainer.clientWidth;
      const scrollLeft = scrollContainer.scrollLeft;
      const maxScroll = scrollWidth - clientWidth;
      
      if (maxScroll <= 0) {
        if (scrollIndicator) scrollIndicator.style.display = 'none';
        return;
      }
      
      if (scrollIndicator) scrollIndicator.style.display = 'flex';
      
      const thumbWidth = (clientWidth / scrollWidth) * 100 * 0.4;
      const scrollPercent = (scrollLeft / maxScroll) * 100;
      
      const finalThumbWidth = Math.max(thumbWidth, 8);
      const maxLeft = 100 - finalThumbWidth;
      const finalLeft = Math.min(scrollPercent, maxLeft);
      
      scrollThumb.style.width = finalThumbWidth + '%';
      scrollThumb.style.left = Math.max(0, finalLeft) + '%';
    }
    
    // Click on track to jump
    scrollTrack.addEventListener('click', function(e) {
      if (e.target === scrollThumb) return;
      
      const trackRect = scrollTrack.getBoundingClientRect();
      const clickX = e.clientX - trackRect.left;
      const trackWidth = trackRect.width;
      const clickPercent = clickX / trackWidth;
      
      const scrollWidth = scrollContainer.scrollWidth;
      const clientWidth = scrollContainer.clientWidth;
      const maxScroll = scrollWidth - clientWidth;
      const targetScroll = clickPercent * maxScroll;
      
      scrollContainer.scrollTo({
        left: targetScroll,
        behavior: 'smooth'
      });
    });
    
    // Drag thumb
    scrollThumb.addEventListener('mousedown', function(e) {
      isDragging = true;
      startX = e.clientX;
      startScrollLeft = scrollContainer.scrollLeft;
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      
      const trackRect = scrollTrack.getBoundingClientRect();
      const trackWidth = trackRect.width;
      const deltaX = e.clientX - startX;
      const deltaPercent = deltaX / trackWidth;
      
      const scrollWidth = scrollContainer.scrollWidth;
      const clientWidth = scrollContainer.clientWidth;
      const maxScroll = scrollWidth - clientWidth;
      const deltaScroll = deltaPercent * maxScroll;
      
      scrollContainer.scrollLeft = Math.max(0, Math.min(maxScroll, startScrollLeft + deltaScroll));
    });
    
    document.addEventListener('mouseup', function() {
      isDragging = false;
    });
    
    scrollContainer.addEventListener('scroll', updateScrollbar);
    window.addEventListener('resize', updateScrollbar);
    updateScrollbar();
  })();
</script>

{%- endif -%}

{% schema %}
{
  "name": "Sub Collections",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Sub Collections"
    },
    {
      "type": "range",
      "id": "item_width",
      "min": 120,
      "max": 400,
      "step": 20,
      "unit": "px",
      "label": "Item width",
      "default": 200
    },
    {
      "type": "text",
      "id": "aspect_ratio",
      "label": "Aspect ratio",
      "default": "1",
      "info": "Height/Width ratio (e.g., 1 = square, 0.8 = 4:5)"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show collection title",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "scheme_1",
      "label": "Color scheme"
    },
    {
      "type": "range",
      "id": "space_above",
      "min": 0,
      "max": 2,
      "step": 0.5,
      "unit": "x",
      "label": "Space above",
      "default": 1
    },
    {
      "type": "range",
      "id": "space_below",
      "min": 0,
      "max": 2,
      "step": 0.5,
      "unit": "x",
      "label": "Space below",
      "default": 1
    }
  ],
  "blocks": [
    {
      "type": "collection_item",
      "name": "Collection",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Optional. If blank, collection's featured image will be used."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Sub Collections"
    }
  ]
}
{% endschema %}
